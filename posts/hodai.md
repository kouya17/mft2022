# 固定砲台型射的ゲームHODAI

## 全体構成図

## 各ユニットの説明

### コントローラー

![コントローラーの外観](/images/Honeyview_IMG_2575.jpg)

距離センサーを使って、手が接近していることを検知するためのユニット。各コントローラーに、一つの方向が割り当てられている。4つのコントローラーを使用することで、上下左右4方向の入力を行うことができる。

#### 主な使用部品

- 距離センサー ×1: https://akizukidenshi.com/catalog/g/gI-02551/
- LED ×1: https://akizukidenshi.com/catalog/g/gI-11577/
- 3Dプリント部品

#### 画像及び詳細

![コントローラーの距離センサー](/images/Honeyview_IMG_2576.jpg)

中央のくぼみ部分に距離センサーを搭載している。

![コントローラーのLED](/images/Honeyview_IMG_2578.jpg)

赤色LEDが1個つけられており、手の接近を検知している間、光る。アクリル板で光をうまく拡散させようと思ったのだが、あまり綺麗に拡散させられていない。

## HODAI

HODAIは以下を行います。

- 赤外線の出力
- コントローラーの制御
- サーボモーターの制御
- カメラ映像のLCD出力

コントローラー(距離センサー)からの入力を読み取り、手が接近しているコントローラーに対応する方向にサーボモーターを動かします。この時、対応するコントローラーのLEDを点灯させます。なお、複数のコントローラーに同時に手が接近している場合、サーボモーターは動かさず、LEDも点灯させません。

赤外線の出力およびカメラ映像のLCD出力は常時行っています。

### 主な使用部品

- Spresenseメインボード x1: https://akizukidenshi.com/catalog/g/gM-14584/
- Spresense拡張ボード x1: https://akizukidenshi.com/catalog/g/gM-14585/
- LCD x1: 
- 小型ボリューム 10kΩ x1: https://akizukidenshi.com/catalog/g/gP-15813/
- プリント基板
- 3Dプリント部品

### 写真及び詳細

配線がめんどくさかったので、LCD及びコントローラーとの接続用にシールド基板を作成しています。

オペアンプを使って、赤外線を矩形波で出力しています。スライドスイッチを操作することにより、50Hz〜500Hzまで矩形波の周波数が変わります(が、使用しているカーボン抵抗及びコンデンサーによってかなりの誤差が発生するので、ざっくりです)。

カメラ映像をLCDに出力させる際、大体中央のところに円形の照準をカメラからの画像に重ねて出力しています。カメラからの映像だけだと味気なかったので照準を追加しました。

可変抵抗器が配線剥き出しで取り付けられており、これを調整することにより操作1回あたりのサーボモーターの移動量を調整できます。今回の展示では、この部分はユーザーが触れないようにしています。

制御用ボードとしてSpresenseを使用しています。特にSpresenseでなければならない理由はなかったのですが、余っていたので使いました。

## 的ユニット

的ユニットは以下を行います。

- HODAIからの赤外線の受信
- 中央デバイスとの通信
- サーボモーター及びフルカラーLEDの制御

HODAIから赤外線を受信している間に、中央デバイスから発射通知を受け取った場合、サーボモーターを動かして的を倒します。この時、中央デバイスに得点したことを通知します。

### 主な使用部品

- フォトトランジスター x12: https://akizukidenshi.com/catalog/g/gI-04211/
- RGBフルカラーLED x12: https://akizukidenshi.com/catalog/g/gI-03037/
- 16×8LEDマトリクスドライバーモジュール x3: https://akizukidenshi.com/catalog/g/gM-11246/
- PCA9685サーボシールド x1: Amazonで購入
- Atom Lite x1: https://www.switch-science.com/catalog/6262/
- プリント基板
- 3Dプリント部品

### 写真及び詳細

上記写真の受信部はフォトトランジスター、フルカラーLED、サーボモーターが搭載されていて、それぞれの部品の配線が伸びています。

フォトトランジスターから伸びている配線は、上記中央制御盤にある赤外線受信モジュールに接続します。この赤外線受信モジュールは、赤外線がOFFになっている時間を測定して、受信している赤外線の周波数を確認します。PICマイコン16F1503を使用しており、プログラムを書き換えることによって処理を変更することも可能です。

フルカラーLEDから伸びている配線は、上記16×8LEDマトリクスドライバーモジュールを利用したプリント基板に接続します。16×8LEDマトリクスドライバーモジュールを、5個のフルカラーLEDを制御するために利用しています。ここら辺については[こちらの記事](https://kouya17.com/posts/15/)でも少し紹介しています。

サーボモーターから伸びている配線は、PCA9685サーボシールドに接続します。サーボ用の電源はACアダプタから供給しています。

全体の制御はATOM Liteで行っています。ATOM Liteは

- ESP32を搭載している
- USB端子がある
- バッテリーがない

という点を満たすものの中で比較的安価なので、手軽に試す用途で好んで使っています。

ATOM Liteから伸びているUSBケーブルは中央デバイスに接続されています。中央デバイスとはシリアル通信を行っています。通信内容の詳細は中央デバイスの説明に記載します。

## フットスイッチユニット

フットスイッチが押されたら、発射音を鳴らし、中央デバイスに発射通知を送信します。

### 主な使用部品

- フットスイッチ x1: Amazonで購入
- Atom Lite x1: https://www.switch-science.com/catalog/6262/
- スピーカー 8Ω8W x1: https://akizukidenshi.com/catalog/g/gP-03285/
- MAX98357A搭載 I2S 3W D級アンプボード x1: https://www.switch-science.com/catalog/2749/
- 3Dプリント部品

### 写真及び詳細

本ユニットを分解すると上記写真のようになっています。中央の層にスピーカーがついており、その下の層にAtomLiteを含めた基板を配置しています。

発射音はアンプボードにI2Sを入力して鳴らしています。音声データはWAVファイルをESP32のSPIFFSに保存しています。

ATOM Liteから伸びているUSBケーブルは中央デバイスに接続されています。中央デバイスとはシリアル通信を行っています。通信内容の詳細は中央デバイスの説明に記載します。

## 中央デバイス

中央デバイスは以下を行います。

- フットスイッチユニット及び的ユニットとの通信
- スコアデータの管理
- ゲーム画面の配信

### 主な使用部品

- Raspberry Pi4 Model B 4GB x1: https://akizukidenshi.com/catalog/g/gM-14778/

### 写真及び詳細

中央デバイスとフットスイッチユニットとの通信内容は上記の通りです。

中央デバイスと的ユニットとの通信内容は上記の通りです。

中央デバイスはスコアデータを[PostgreSQL](https://www.postgresql.org/)を用いて保存しています。スコアデータの追加・参照は[Flask](https://flask.palletsprojects.com/)を用いたWebAPIアプリケーションから行います。

中央デバイスでは[Phaser](https://phaser.io/)を用いて作成したゲーム画面用Webアプリケーションを稼働させています。ブラウザから対象URLにアクセスすることで、ゲーム画面を描画できます。今回の展示では、中央デバイスとPCをLANケーブルで直結し、PCのブラウザから対象URLにアクセスする形式をとっています。

## ステージ

的ユニットを配置する土台です。

### 主な使用部品

- 3Dプリント部品

### 画像及び詳細

サイズの関係上、分割してプリントしてゴリ押しました。最終的には輸送時のサイズの関係も考慮しつつ、3分割になるように接着剤でくっつけました。分割されている部分は的ユニットを配置することによって結合します。強度は度外視してます。当日輸送時に壊れているかもしれません(これは他の部品も同様ですが)。